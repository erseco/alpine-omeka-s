name: Sync Omeka-S Tags

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch: # Allows manually triggering

jobs:
  sync-tags:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create and push tags

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Omeka S tags >= v4.0.0
        id: get-omeka-tags
        run: |
          echo "Fetching Omeka S tags from GitHub API..."
          OMEKA_TAGS=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/omeka/omeka-s/tags" | \
            jq -r '.[].name' | \
            grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | \
            grep -E '^v4\.[0-9]+\.[0-9]+$|^v[5-9][0-9]*\.' | \
            sort -V)
          echo "Filtered and sorted Omeka S tags:"
          echo "$OMEKA_TAGS"

          echo "omeka_tags=$OMEKA_TAGS" >> $GITHUB_ENV

      - name: Get existing tags
        id: get-existing-tags
        run: |
          git fetch --tags
          EXISTING_TAGS=$(git tag -l)
          EXISTING_TAGS_FORMATTED=$(echo "$EXISTING_TAGS" | tr '\n' ' ')
          echo "existing_tags=$EXISTING_TAGS_FORMATTED" >> $GITHUB_ENV

      - name: Process missing tags
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          omeka_tags: ${{ env.omeka_tags }}
          existing_tags: ${{ env.existing_tags }}
        run: |
          EXISTING_TAGS_PATTERN=" $existing_tags "
          PROCESSED=0

          for tag in $omeka_tags; do
            if [[ "$EXISTING_TAGS_PATTERN" == *" $tag "* ]]; then
              echo "Tag $tag already exists, skipping"
              continue
            fi

            echo "Creating new tag: $tag"
            git tag "$tag"
            git push origin "$tag"

            echo "Triggering build for tag $tag"
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GH_PAT" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/dispatches \
              -d '{
                "ref": "refs/tags/'"$tag"'",
                "inputs": {
                  "omeka_version": "'"$tag"'"
                }
              }'

            PROCESSED=$((PROCESSED+1))
          done

          echo "Process completed. Created $PROCESSED new tags."

      - name: Summary
        run: |
          echo "# Omeka S Tags Synchronization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Omeka S tags found: $(echo "${{ env.omeka_tags }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "- Existing tags: $(echo "${{ env.existing_tags }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "- New tags created: $(git tag -l | wc -w) - $(echo "${{ env.existing_tags }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
